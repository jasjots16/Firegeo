<!DOCTYPE html>
<html>
<head>
    <title>Simple OAuth Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🔍 Simple OAuth Test</h1>
    
    <div>
        <h2>Current Status:</h2>
        <div id="status">Checking...</div>
    </div>
    
    <div>
        <button onclick="testOAuth()">🔐 Test Google OAuth</button>
        <button onclick="checkSession()">🔍 Check Session</button>
        <button onclick="clearLogs()">🗑️ Clear Logs</button>
    </div>
    
    <div>
        <h2>Logs:</h2>
        <div id="logs"></div>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = `[${timestamp}] ${message}`;
            document.getElementById('logs').appendChild(logDiv);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function checkSession() {
            log('🔍 Checking session...');
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'
                });
                const data = await response.json();
                log(`📊 Session: ${JSON.stringify(data, null, 2)}`);
                
                if (data.user) {
                    document.getElementById('status').innerHTML = `✅ Logged in as: ${data.user.email}`;
                } else {
                    document.getElementById('status').innerHTML = '❌ Not logged in';
                }
            } catch (error) {
                log(`❌ Session check failed: ${error.message}`);
            }
        }

        async function testOAuth() {
            log('🚀 Starting OAuth test...');
            
            try {
                log('📤 Calling POST /api/auth/sign-in/social...');
                
                const response = await fetch('/api/auth/sign-in/social', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google'
                    }),
                    credentials: 'include'
                });
                
                log(`📥 Response status: ${response.status}`);
                
                if (response.status === 200) {
                    log('✅ OAuth initiated successfully');
                    
                    // Check if we got a redirect
                    const responseText = await response.text();
                    log(`📄 Response body: ${responseText.substring(0, 200)}...`);
                    
                    // In a real OAuth flow, the browser should redirect to Google
                    log('🔄 In a real flow, browser should redirect to Google now');
                    log('⚠️ If no redirect happened, check callback URL in Google Cloud Console');
                } else {
                    const errorText = await response.text();
                    log(`❌ Error: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                log(`💥 Exception: ${error.message}`);
            }
        }

        // Check session on page load
        checkSession();
    </script>
</body>
</html>